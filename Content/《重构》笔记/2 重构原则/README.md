# 2 重构原则

- [2 重构原则](#2-重构原则)
  - [2.1 何谓重构](#21-何谓重构)
  - [2.2 为何重构](#22-为何重构)
  - [2.3 何时重构](#23-何时重构)
  - [2.4 怎么对经理说](#24-怎么对经理说)
  - [2.5 重构的难题](#25-重构的难题)
  - [2.6 重构与设计](#26-重构与设计)
  - [2.7 重构与性能](#27-重构与性能)
  - [2.8 重构起源何处](#28-重构起源何处)

## 2.1 何谓重构

1. 重构是对软件内部结构的一种调整, 目的是在不改变软件可观察行为的前提下, 提高其可理解性, 降低其修改成本
2. 与重构形成对比的是性能优化, 性能优化一般也不会影响软件的观察行为, 但是代码的可理解性常常会与效率妥协变得难以理解
3. 软件开发中应该时刻记得把自己分为两种状态：1.添加功能；2.重构. 
4. 添加功能时, 不应该修改与功能无关的代码, 只管添加功能和通过测试
5. 重构时, 不应该添加新功能, 只应该专注于改进程序的结构

## 2.2 为何重构

1. 软件开发之中, 代码不可避免地会越来越乱, 如果永远只是为了短期利益修改代码, 那么程序必然逐渐失去自己的结构. 重构就像是整理代码, 不断提炼代码的意图, 帮助维持代码的形态
2. 改进设计的重要方向就是减少重复的代码, 方便未来对代码的修改
3. 重构模式编程的核心就是理解代码, 然后修改代码, 让代码本身更好地表达出我们的理解
4. 遇到不熟悉的代码时我们也可以进行重构, 重构的途中慢慢理解代码, 然后重新执行看看行为是否正常来验证自己的猜想
5. 随着重构, 我们将在日益简洁的代码中看到一些以前看不到的设计层面的问题
6. ”我不是个伟大的程序员, 我只是个有着一些优秀习惯的程序员“
7. 重构还能提高我们的编程速度, 没有良好设计的时候盲目进行编程也许一段时间内能进展迅速, 但是随着发展会越来越难把握, 未来的开发会越来越困难
8. 良好设计是维持软件开发速度的根本. 重构可以帮助你更快速地开发软件, 因为它阻止系统腐败变质, 它甚至还可以提高设计质量

## 2.3 何时重构

1. 重构不是一件应该特别拨出时间做的事情, 重构应该随时随地进行. 我们不应该为重构而重构, 之所以重构, 是因为我们想做别的什么事时, 重构可以帮助我们把那些事做好
2. 三次法则：第一次做某件事时只管去做；第二次会反感, 但还是可以做；第三次就应该重构
3. 添加功能时：用重构来理解别人的代码令我们快速添加新功能；当发现某些功能重构后可以变得容易添加时可以重构
4. 修补错误：遇到bug时进行, 因为代码结构没有清晰到让我们一眼看出bug
5. 复审代码：重构可以让我们更快理解别人的代码且发现他人代码结构中的问题. 对于他人代码中的错误可以以极限编程的思路直接动手重构, 但是如果项目过大则应该以图示提交重构的思路
6. “如果我们纯粹只是为了今天工作, 明天我将无法工作”
7. 我们希望程序：(1)容易阅读；(2)所有逻辑都只在唯一地点指定；(3)新的改动不会危及现有行为；(4)尽可能简单表达条件逻辑. 

## 2.4 怎么对经理说

1. 最好就是不要告诉经理重构的意图, 我们需要重构来提高开发速度, 那么就尽可能快地完成重构
2. “计算机科学是这样一门科学：它相信所有问题都可以通过增加一个间接层来解决. ”
3. 重构的两种核心思路：找到缺乏间接层的地方, 加入一个间接层. 找到多余的间接层, 删去这种过度设计

## 2.5 重构的难题

1. 重构并不是毫无缺点, 我们应该时时监控重构的行为, 时刻注意重构可能引入的问题
2. 在两个模型之间加入一个分隔层可以隔离两个组件的变化
3. 修改接口是重构的重要事项, 要非常谨慎
4. 普通接口的改名只要直接文本替换就能实现, 但是那些已经发布给外部人员使用的接口则不容易. 对于这种情况最好先让旧接口调用新接口并让两者共存, 标记为“弃用”, 然后在足够久的未来后删去旧接口
5. 对于内部团队可以让其他人自由修改别人的代码, 不要太过强调代码所有权, 这样才能让接口应用更加自由
6. 开发之前不要过度设计, 但也不能不要设计. 应该先思考若出现了某种预期之外的变化, 进行对应的重构会不会过于复杂, 如果会就进行详细设计, 否则就使用最简单的设计哪怕它不够全面
7. 进行重构之前必须保证代码可以基本正常运作, 否则重构无从开始. 如果代码基本无法正常运作, 连测试都很困难, 我们就应该考虑进行重写而非重构
8. 对大型程序进行重构时, 最好将其重构为大量封装良好的小组件的组合, 这样对未来的重构和修改也容易
9. 快速开发的时候常常无法进行重构, 特别是截止日期前不要去重构. 但是日期一过就该进行重构防止未来更大的坑出现, 在坑小时就解决问题

## 2.6 重构与设计

1. 快速开发的关键就是只选择简单够用的设计, 然后着手开发, 再周期性进行重构
2. 很多前期开发时留下的灵活性设计都是无用的, 多选择简单方案即可
3. 度量程序性能很重要, 很多对性能的估测都是错误的, 实验才是检验真理的唯一标准

## 2.7 重构与性能

1. 先写出可调的软件, 然后再进行性能优化, 不要有太多预先设计
2. 三种编写高性能软件的方法：
    1. 预计算每个模块的耗时然后严格按照要求开发的时间预算法, 这种方法对大多数软件都太严苛类
    2. 在开发的时候就持续关注性能的持续关注法, 这种方法容易让程序员耗费优化时间于一些小模块上, 但是优化应该注重于耗时很大的大模块
    3. 先完成设计然后再按照统计数据进行重构优化的统计优化法, 这种方法在前期可能使软件比较慢但是最终还是有好效果, 关键是在后期着重性能大头然后像重构一样反复修改-度量-考虑

## 2.8 重构起源何处

1. 借助重构工具也很重要
2. 依赖统计和性能度量大大优化来重构的效果