# P3 Smoothing 平滑化

- [P3 Smoothing 平滑化](#p3-smoothing-平滑化)
  - [去噪](#去噪)
  - [拉普拉斯平滑](#拉普拉斯平滑)
  - [图像去噪](#图像去噪)
  - [网格双边去噪](#网格双边去噪)
  - [双边法线滤波](#双边法线滤波)
  - [流形谐波处理](#流形谐波处理)
  - [作业](#作业)

## 去噪

去噪的本质是在对数据重要部分生成一个估计, 然后抛弃掉数据不重要的一些不符合规律的信息, 在这里噪声信息通常都是高频的, 但是噪声会和细节混在一起, 所以比较难处理. 去噪主要有三种大方法: 基于滤波的方法, 基于优化的方法, 基于数据学习的方法.

## 拉普拉斯平滑

对于一个与时间和空间都有关的函数, 拉普拉斯算子可以得到这样的一个扩散方程, 也就是对函数基于时间求导:

![picture 1](Media/69ac5d01ca52d96409ef44724d6a62a6b4a255887fb56b8b35287f28483db77b.png)  

在计算机中, 这样的扩散方程我们需要进行空间离散化和时间离散化才能满足要求. 理解为固定一个参数, 偏微分另一个参数. 其中空间离散化我们已经比较熟悉, 就是将拉普拉斯算子换成拉普拉斯矩阵, 不同的拉普拉斯矩阵会导致不同的函数估计结果

![picture 2](Media/ac438677fb0a439e11b702607ac37bb1d704e1d93e89daca80d93af5292d3ae4.png)  

而时间离散化则是迭代的思想, 用较小的迭代步长h来代替微分的时间量, 将这个离散时间和空间离散化公式结合起来, 通过显式欧拉积分, 我们可以得到下一个时间点的函数值:

![picture 3](Media/7e8b17604f2b3c3669f5df07cd90aa01c629cc5788461db77b58bda00bc7665d.png)  

对于这个部分, 除了使用上面的迭代法求解外, 我们还可以通过隐式欧拉积分, 通过求解下面的方程来得到下个时间点的函数值. 求解方程的方法有更好的数值稳定性, 但是计算速度更慢

![picture 4](Media/7ac64f0b8df6e4d4d6d879897a6c25bb6ac3f326077eddc116509b6fab3fa616.png)  

综合起来, 拉普拉斯平滑就是通过自定义的拉普拉斯矩阵, 迭代改变当前的顶点, 不同的矩阵会起到不同的平滑效果. 
- 其中上一节的cot形式拉普拉斯矩阵能够不断减小表面的曲率, 在减小曲率的同时会保留网格大致特征, 在平滑部分仍然能够保持平滑
- 而uniform形式的拉普拉斯矩阵则会将网格顶点往邻域平均值位置移动, 由于不像cot形式能够满足线性性(LIN), 因此网格会有一种不断变平的趋势, 不但网格分布逐渐变得统一, 而且网格本身也在变扁, 即使是平滑区域也会不断改变.

![picture 5](Media/27afa76ed4110ad9920a4392b45f72592a2191aecabf72c0f4d00807ee5ace4b.png)  

Fairing(光顺)是指让两个区域之间生成的网格尽可能平滑的操作, 通过令拉普拉斯矩阵与顶点操作为0生成的网格会满足一定的平滑性. 而随着采用的L矩阵的阶数的增加, 网格会越来越平滑, 下图右边采用三阶次的拉普拉斯矩阵$L^3x=0$得到了非常平滑的连接效果

![picture 6](Media/c24b4e3636670281f1713e2107b9d175132a2ca1b095f216b4e6aa7632cfe62d.png)  

## 图像去噪

图像去噪任务与网格去噪有相近之处. 在图像去噪中, 最出名的去噪滤波器就是高斯滤波器, 高斯滤波器的计算方法如下式, 用一个高斯分布的函数按照邻域点到重心点的距离生成权值, 利用权值和前面的正则化项对邻域内的图像亮度值取加权平均得到当前点的目标亮度值.

![picture 1](Media/d96d8a67f91369c2487692d62401a03ab28e6811bd7194515b68ddd2a9428b91.png)  

高斯去噪的缺点就是其没法很好地保留细节特征, 经过高斯滤波器处理的图像整体都变模糊了. 因此又提出了双边去噪法, 其除了像高斯去噪一样考虑邻域点到重心点的距离, 还额外考虑了这些点自身的亮度值差异, 将这个差异加入考虑后去噪结果可以保留图像的边缘信息.

![picture 1](Media/d7ef9f7e5f21279efe60300d0874de2b7240f7f193924a28179c19c04ea02685.png)  

## 网格双边去噪

将双边滤波器扩展到网格域的思想的核心就是在三维空间中得到类似深度值的信息, 提出双边网格去噪的文献Bilateral Mesh Denoising采用的方法就是先插值得到表面每个顶点的法线, 然后在顶点法线的切平面上, 衡量邻域顶点与这个切平面的高度差, 这个高度差就是双边滤波器的亮度值, 顶点之间的距离就是双边滤波器的位置信息, 这样计算出来的值加权平均后应用在顶点的法线方向上就能得到更新后的顶点坐标. 在实现过程中要注意的问题是顶点法线如何插值比较合理, 还有就是在平滑过程中网格自身的体积会发生变化, 要如何操作来尽量保持网格的体积.

![picture 3](Media/7ea288ecb4d554085f83b087c8ccae91a3dd182c2d9660568e7af62d7fd7350b.png)  

## 双边法线滤波

这是来自文章Bilateral Normal Filtering for Mesh Denoising的方法, 其特点在于考虑了表面面片之间的法线变化信息. 在双边法线滤波中, 首先由于面片上才能得到稳定的法线, 因此滤波的核心从顶点变成了面片法线, 然后双边滤波器的位置差变成了面片重心与邻域面片中心的距离差, 亮度值变为邻域上的法线与当前法线的角度差. 然后由于滤波的核心是法线, 因此计算得到的滤波值会被应用在法线上, 加权平均后用来调整当前的法线.

![picture 5](Media/94119f2ecb942611cd98f3cdc1f0f5eaf861c55f7a17549d0d9655b2450eaebd.png)  

得到一次迭代中全局的新法线后, 使用优化方法利用这些法线方向优化当前表面上的顶点, 让表面顶点形成的真正的新顶点能和当前法线尽可能相同. 这个优化过程本质上就是求解最小化下面能量函数所决定的线性方程组. 这个能量函数的原理就是由于法线理论上应该与表面上每个边都垂直, 所以最小化迭代后的法线与当前面片的边点乘后的值, 最优情况就是全垂直也就是都为0. 用数值计算中常用的求解方法来最小化这个能量函数即可, 可以直接求解方程组也可以用雅可比迭代或高斯-赛德尔迭代等迭代方法近似求解.

![picture 6](Media/1d28751efd048571b7f9c4dd46e5cc4b3d447c5be03af70fb9ac5dbe22810b26.png)  

然后对于这个平滑还可以额外引入对法线进行拉普拉斯处理最小化新法线的二阶导变化和最小化新旧法线之间的变换量等能量函数一起优化:

![picture 8](Media/8ebae0e6dea86626f817c9848c1731f01beb4476e9e63fc17019b70096fb7202.png)  

最后的平滑效果

![picture 9](Media/dee78ccc35271757f9eaec3df9faceb374f1cfc0d37ac8f35901bb3bfa9c4d93.png)  

## 流形谐波处理

流形谐波是文章Spectral Geometry Processing with Manifold Harmonics从傅里叶变换推广出来的处理方法, 我们知道傅里叶变换可以将信号从平时常见的空域转到时域也就是频谱形式(见[虎书9.5](...)), 然后在频谱上我们可以方便对信号进行很多处理例如消去起到高频信号平滑效果, 对不同频率的信号进行缩放从而对空域的信号进行改变.

对于傅里叶变换, 我们可以换一种思路来理解它, 对于一个一维信号, 我们通过下面的式子能将信号从空域转到时域然后再转回空域. 这个式子中我们可以将$g(x)$理解为信号$f(x)$的与频率相关的分量基函数, 称为谱函数, 而$<f(x),g(x)>$就是信号在谱函数上的投影, 将一个信号投影到频域后我们自然可以重新按照频率将这个信号积分回来. 因此我们可以通过调整积分的方法来有目的性地改变还原出来的信号状态.

![picture 10](Media/08c208e4f2d30324f0394179ea45f0914aaa0e558ef031211bfea9fe717ffa6f.png)  

对于这个谱函数, 如果我们使用拉普拉斯算子对其计算, 会得到下面的形式. 注意到这里等式两边的后半部分是没有改变的, 而右边部分的前半部分$-(2\pi\omega)^2$则是一个与参数x无关的常数, 这个形式很接近线性代数中特征值和特征向量的性质. 再加上我们知道在离散中拉普拉斯算子会退化为拉普拉斯矩阵, 那么这个式子就与特征值和特征向量形式完全一样了. 由于形式相同, 我们可以想到, $-(2\pi\omega)^2$可以当作拉普拉斯矩阵$L$的特征值分解出来, 而谱函数就是分解出来的特征向量. 当拉普拉斯矩阵式对称且半正定时, 这个分解是稳定的.

![picture 11](Media/f76462a75119596ee074e6b835ccb78647556fdf84ceecf18dc4f8e3ce363188.png)  

经过这样的分解, 我们可以很方便地将信号傅里叶变换到频率域中, 然后利用离散积分的特性, 选择所需的分量进行积分就能得到滤波的效果. 以低通滤波为例, 将频率高于一定值m的部分不进行积分, 就能让三维信号平滑

![picture 12](Media/bcbc4707d9cc3d06118b5b5f0ba65ec2fb7de881bf0b89519d142a943424037c.png)  

相类似的, 还有其它几种形状的滤波器可以使用并得到不同的效果. 这种方法很理想, 效果也很好, 但是缺点是由于复杂的模型的拉普拉斯矩阵很大, 对其进行特征值分解会变得很困难, 2018年文章Fast Approximation of Laplace-Beltrami Eigenproblems加速了这个过程得到近似的特征值分解.

![picture 13](Media/99ce4868271340ff760a32bbbf1c1d581ae87a58dda32a9ddae6dcd8ce56be5b.png)  


## 作业

![picture 7](Media/326205305491483747ecb16ada868b7dbe13ff6defdb788483ba1dfaa9a2f5ee.png)  

![picture 8](Media/8751866a7ef1833e0d5406171b87db17aeb4747e3845a3eb94da549965e27798.png)  
